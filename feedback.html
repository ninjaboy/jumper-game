<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GROUNDED - Player Feedback Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2c3e50 100%);
            color: #ecf0f1;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 10px;
            border: 2px solid #3498db;
        }

        h1 {
            font-size: 48px;
            color: #3498db;
            text-shadow: 0 0 10px #3498db;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #95a5a6;
            font-size: 18px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: #34495e;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #555;
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #95a5a6;
            font-size: 14px;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        select {
            background: #34495e;
            color: #ecf0f1;
            border: 2px solid #555;
            padding: 10px;
            border-radius: 5px;
            font-size: 16px;
        }

        .feedback-table {
            background: #2c3e50;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #3498db;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #34495e;
            color: #3498db;
            padding: 15px;
            text-align: left;
            font-weight: bold;
            border-bottom: 2px solid #3498db;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #444;
        }

        tr:hover {
            background: rgba(52, 152, 219, 0.1);
        }

        .comment {
            max-width: 400px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .comment.expanded {
            white-space: normal;
        }

        .timestamp {
            color: #95a5a6;
            font-size: 14px;
        }

        .mode-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            background: #27ae60;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 24px;
            color: #3498db;
        }

        .error {
            background: #c0392b;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .empty {
            text-align: center;
            padding: 50px;
            color: #95a5a6;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸŽ® GROUNDED</h1>
            <p class="subtitle">Player Feedback Dashboard</p>
        </header>

        <div id="error" class="error" style="display: none;"></div>

        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalFeedback">-</div>
                <div class="stat-label">Total Feedback</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgLevel">-</div>
                <div class="stat-label">Avg Level Reached</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="withComments">-</div>
                <div class="stat-label">With Comments</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="topMode">-</div>
                <div class="stat-label">Most Popular Mode</div>
            </div>
        </div>

        <div class="controls">
            <button onclick="loadFeedback()">ðŸ”„ Refresh</button>
            <button onclick="exportCSV()">ðŸ“¥ Export CSV</button>
            <select id="modeFilter" onchange="filterFeedback()">
                <option value="">All Modes</option>
            </select>
            <select id="levelFilter" onchange="filterFeedback()">
                <option value="">All Levels</option>
            </select>
        </div>

        <div class="feedback-table">
            <table>
                <thead>
                    <tr>
                        <th>Date/Time</th>
                        <th>Level</th>
                        <th>Mode</th>
                        <th>Bias</th>
                        <th>Progress</th>
                        <th>Seed</th>
                        <th>Comment</th>
                    </tr>
                </thead>
                <tbody id="feedbackBody">
                    <tr><td colspan="7" class="loading">Loading feedback...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let allFeedback = [];
        let filteredFeedback = [];

        async function loadFeedback() {
            try {
                const response = await fetch('/api/get-feedback');
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load feedback');
                }

                allFeedback = data.feedback || [];
                filteredFeedback = allFeedback;
                updateStats();
                populateFilters();
                renderFeedback();

                document.getElementById('error').style.display = 'none';
            } catch (error) {
                console.error('Error loading feedback:', error);
                document.getElementById('error').textContent = `Error: ${error.message}`;
                document.getElementById('error').style.display = 'block';
                document.getElementById('feedbackBody').innerHTML =
                    '<tr><td colspan="7" class="empty">Failed to load feedback. Click Refresh to try again.</td></tr>';
            }
        }

        function updateStats() {
            const total = allFeedback.length;
            document.getElementById('totalFeedback').textContent = total;

            if (total === 0) {
                document.getElementById('avgLevel').textContent = '-';
                document.getElementById('withComments').textContent = '-';
                document.getElementById('topMode').textContent = '-';
                return;
            }

            // Average level
            const avgLevel = (allFeedback.reduce((sum, f) => sum + f.level, 0) / total).toFixed(1);
            document.getElementById('avgLevel').textContent = avgLevel;

            // Comments count
            const withComments = allFeedback.filter(f => f.comment && f.comment.length > 0).length;
            document.getElementById('withComments').textContent = `${withComments} (${Math.round(withComments/total*100)}%)`;

            // Most popular mode
            const modes = {};
            allFeedback.forEach(f => modes[f.jumpMode] = (modes[f.jumpMode] || 0) + 1);
            const topMode = Object.entries(modes).sort((a, b) => b[1] - a[1])[0];
            document.getElementById('topMode').textContent = topMode ? topMode[0].toUpperCase() : '-';
        }

        function populateFilters() {
            const modes = [...new Set(allFeedback.map(f => f.jumpMode))].sort();
            const levels = [...new Set(allFeedback.map(f => f.level))].sort((a, b) => a - b);

            const modeFilter = document.getElementById('modeFilter');
            modeFilter.innerHTML = '<option value="">All Modes</option>' +
                modes.map(m => `<option value="${m}">${m.toUpperCase()}</option>`).join('');

            const levelFilter = document.getElementById('levelFilter');
            levelFilter.innerHTML = '<option value="">All Levels</option>' +
                levels.map(l => `<option value="${l}">Level ${l}</option>`).join('');
        }

        function filterFeedback() {
            const modeFilter = document.getElementById('modeFilter').value;
            const levelFilter = document.getElementById('levelFilter').value;

            filteredFeedback = allFeedback.filter(f => {
                if (modeFilter && f.jumpMode !== modeFilter) return false;
                if (levelFilter && f.level !== parseInt(levelFilter)) return false;
                return true;
            });

            renderFeedback();
        }

        function renderFeedback() {
            const tbody = document.getElementById('feedbackBody');

            if (filteredFeedback.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty">No feedback entries found.</td></tr>';
                return;
            }

            tbody.innerHTML = filteredFeedback.map(f => {
                const date = new Date(f.timestamp);
                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();

                return `
                    <tr>
                        <td class="timestamp">${dateStr}</td>
                        <td><strong>Level ${f.level}</strong></td>
                        <td><span class="mode-badge">${f.jumpMode.toUpperCase()}</span></td>
                        <td>${f.levelBias || 'normal'}</td>
                        <td>${f.progress}%</td>
                        <td><code>${f.seed}</code></td>
                        <td class="comment">${f.comment || '<em style="color: #7f8c8d;">No comment</em>'}</td>
                    </tr>
                `;
            }).join('');
        }

        function exportCSV() {
            const headers = ['Timestamp', 'Level', 'Mode', 'Bias', 'Progress', 'Seed', 'Comment'];
            const rows = filteredFeedback.map(f => [
                new Date(f.timestamp).toISOString(),
                f.level,
                f.jumpMode,
                f.levelBias || 'normal',
                f.progress + '%',
                f.seed,
                (f.comment || '').replace(/"/g, '""') // Escape quotes
            ]);

            const csv = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `grounded-feedback-${Date.now()}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Load feedback on page load
        loadFeedback();
    </script>
</body>
</html>
